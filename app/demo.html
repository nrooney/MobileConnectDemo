
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>GameZube</title>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/style.css" rel="stylesheet"> 

    <!-- Custom styles for this template -->
    <!-- <link href="bower_components/stylesheets/starter-template.css" rel="stylesheet"> -->

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="../../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<!-- MOBILE CONNECT DEMO -->
<!-- STEP 1: Downloading and including the HTML5 SDK. -->
<script language="JavaScript" src="/mobileconnectdemo/app/assets/javascripts/DiscoverySDK.js" type="text/javascript"></script>
<script language="JavaScript" src="/mobileconnectdemo/app/assets/javascripts/LogoSDK.js" type="text/javascript"></script>
<script language="JavaScript" src="/mobileconnectdemo/app/assets/javascripts/Base64Utils.js" type="text/javascript"></script>
<script language="JavaScript" src="/mobileconnectdemo/app/assets/javascripts/OpenIdConnectSDK.js" type="text/javascript"></script>

<script language="JavaScript">

window.localStorage.clear();

var discoveryServiceUriDefault="https://stage-exchange-test.apigee.net/gsma/v2/discovery"; //NOT GOING TO CHANGE 
var discoveryServiceUri="https://stage-exchange-test.apigee.net/gsma/v2/discovery"; 
var discoveryClientID="bAGDtUyghGlOMoml7mTD2SCypkjvXFfc"; 
var discoveryClientSecret="Z9hy5sz8DALmBpn6MR7Nvd04"; 
var logoServiceUri="https://sb2.exchange.gsma.com/v1/logo"; 

var apiClientID=null;
var apiClientSecret=null;

var operatorIdentified=false; //SHOULD BE USING THIS SOMEWHERE!
var operatorName = null;
var mcc=null;
var mnc=null;
var discRespApiClientID = null;
var discRespSubscriberId = null;
var authorizationEndpoint = null;

var authorizationEndpoint=null;

function atStartup() {
    console.log("\nIN FUNCTION: atStartup");

    $("#cannotFindOperator").show();
    $("#foundOperator").hide();
    $("#timeToLogin").hide();
    getLogos();
}

function getLogos() {
    console.log("\nIN FUNCTION: getLogos");

    var sourceIP=null;
    var logosize="medium";
    var colormode="normal";
    var aspect="landscape";
    var mcc=null;
    var mnc=null;
    getLogo(logoServiceUri, mcc, mnc, sourceIP, 'operatorid', logosize, colormode, aspect, logoComplete);
}
  
function logoComplete(logoResult) {
    console.log("\nIN FUNCTION: logoComplete");

    if (logoResult && logoResult.logos && logoResult.logos.length>=1) {
        var url = getCacheApiLogo('exchange', 'operatorid', 'medium', 'normal', 'landscape');
        if (!!url) {
            var first = logoResult.logos[0];
            url = first.url;
        }
        if (!!url) {
            $('#loginlogo').html('<img src=\''+url+'\'alt=\'Login with Mobile Connect\'/>');
        }
    }
}

function startDemo(){
    // steve's demo parsed mnc mcc here
    startActiveDiscovery();
}

function startActiveDiscovery() {
    console.log("\nIN FUNCTION: startActiveDiscovery");
    var encrypt="basic";
    var sourceIP=null;
    var msisdn=null;
    var redirectUri="http://thisnatasha.com/mobileconnectdemo/app/discovered.html"; 
    var mcc=null;
    var mnc=null;

    getDiscoveryActive(discoveryServiceUri, discoveryClientID, discoveryClientSecret, encrypt, mcc, mnc, msisdn, sourceIP, redirectUri, activeDiscoveryComplete);
}

function activeDiscoveryComplete(discoveryResult, status) {
    console.log("\nSUCCESS: Active Discovery Complete");

    console.log("    HTTP Status Code: "+status);
    console.log("    Callback for: "+JSON.stringify(discoveryResult));
    // console.log("Location = "+window.location.href);

    if (status==200) {
        $('#status').val('Discovery complete');
        if (discoveryResult && !!discoveryResult.getResponse()) {
            if (discoveryResult.getResponse().
                getApiFunction('operatorid', 'authorization')) {
                parseDiscoveryResult(discoveryResult)
            }
        }
    }
}

function parseDiscoveryResult(discoveryResult){
    console.log("\nIN FUNCTION: parseDiscoveryResult");

    console.log(discoveryResult);

    operatorName = discoveryResult.getResponse().getServing_operator();
    discRespApiClientID = discoveryResult.getResponse().getClient_id();
    discRespSubscriberId = discoveryResult.getResponse().getSubscriber_id();
    authorizationEndpoint = discoveryResult.getResponse().getApiFunction('operatorid', 'authorization');

    runAuthorization();

    $("#cannotFindOperator").hide();
    $("#foundOperator").show();
    $("#foundOperator #foundOperatorName").text(operatorName);
}

function  runAuthorization(){
    console.log("\nIN FUNCTION: runAuthorization");
    var prompt='login';
    var max_age=3600;
    var acr_values='2';
    var login_hint=null;
    // if (!!discoveryResult.subscriberId) {
    //     login_hint="ENCR_MSISDN:"+subscriberId;
    // }

    var authorizationOptions = new AuthorizationOptions('page', 'en', 'en', 'Enter MSISDN', login_hint, null);
    var state='State'+Math.random().toString(36);
    var nonce='Nonce'+Math.random().toString(36);
    var redirect_uri='http://thisnatasha.com/mobileconnectdemo/app/authorization.html';

    // REWRITING THE AUTHORISATION ENDPOINT HERE TO REFLECT DIALOG PLATFORM
    authorizationEndpoint = "https://identity.mifetest.com:9443/oauth2/authorize";
    discRespApiClientID = "gn_4etsUykydKQ7KmluCfuOHZFka";
    apiClientSecret = "XMulJazG3Y3nKjoWrcgKKYsYDHga";
    // END

    console.log("BEFORE AUTHORISE");
    console.log("    OVERWRITTEN authorizationEndpoint: " + authorizationEndpoint); 
    console.log("    OVERWRITTEN discRespApiClientID: " + discRespApiClientID);
    console.log("    OVERWRITTEN apiClientSecret: " + apiClientSecret);
    // console.log("    redirect_uri: " + redirect_uri);
    // console.log("    state: " + state);
    // console.log("    nonce: " + nonce);
    // console.log("    prompt: " + prompt);
    // console.log("    max_age: " + max_age);
    // console.log("    acr_values: " + acr_values);
    // console.log("    authorizationOptions: ");
    console.log(authorizationOptions);
    authorize(authorizationEndpoint, discRespApiClientID, 'openid profile email userinfo', redirect_uri, 'code', state, nonce, prompt, max_age, acr_values, authorizationOptions, authorizationCallbackFunction);
}

function authorizationCallbackFunction(data) {
    console.log("\nIN FUNCTION: authorizationCallbackFunction");

    var code=data['code'];
    var state=data['state'];
    var error=data['error'];

    var discoveryDetails=getCacheDiscoveryItem();
    var tokenEndpoint=discoveryDetails.getResponse().getApiFunction('operatorid', 'token');
    var apiClientID=discoveryDetails.getResponse().getClient_id();
    var apiClientSecret=discoveryDetails.getResponse().getClient_secret();

    // REWRITING THE TOKEN ENDPOINT HERE TO REFLECT DIALOG PLATFORM, CLIENT ID, CLIENT SECRET
    tokenEndpoint = "https://identity.mifetest.com:9443/oauth2/token";
    apiClientID = "gn_4etsUykydKQ7KmluCfuOHZFka";
    apiClientSecret = "XMulJazG3Y3nKjoWrcgKKYsYDHga";
    // END

    console.log("OVERWRITTEN tokenEndpoint: " + tokenEndpoint);
    console.log("OVERWRITTEN apiClientID: " + apiClientID);
    console.log("OVERWRITTEN apiClientSecret: " + apiClientSecret);
    console.log("Data: " + data);

    // console.log("BEFORE call: tokenFromAuthorizationCode");      
    // if (code && code!=null && (code.trim().length)>0) {
        $('#status').val('Authorized');
        $('#code').val(code);

        tokenFromAuthorizationCode(tokenEndpoint, code, apiClientID, apiClientSecret,'http://mc.mobilesites.net/authorised.html', tokenReceived);
    // } else {
    //     console.log("error");
    //     $('#status').val('Error');
    // }
}

function tokenReceived(token) {
    console.log("\nIN FUNCTION: tokenReceived");
    console.log(token);

    if (!!token.refresh_token) $('#refresh_token').val(token.refresh_token);
    if (!!token.expires_in) $('#expires_in').val(token.expires_in);
    if (!!token.token_type) $('#token_type').val(token.token_type);
    if (!!token.access_token) {
        $('#access_token').val(token.access_token);
        var discoveryDetails = getCacheDiscoveryItem();
        var userinfoEndpoint = discoveryDetails.getResponse().getApiFunction('operatorid', 'userinfo');
        $('#status').val('Authorized + access token retrieved');
        if (userinfoEndpoint && userinfoEndpoint.trim().length>0) {
            userinfo(userinfoEndpoint, token.access_token, userinfoCallbackFunction);
        }
    }
}

function userinfoCallbackFunction(userinfo) {
    if (!!userinfo.email) $('#email').val(userinfo.email);
    if (userinfo && userinfo.email_verified!==null) 
        $('#email_verified').val(
            userinfo.email_verified?'true':'false');
}


</script>
<!-- /END MOBILE CONNECT DEMO -->

  </head>

  <body onLoad='javascript:atStartup();'>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">GameZube</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#login">Login</a></li>
            <li><a href="#features">Features</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
        
        <div class="jumbotron apptitle">
            <div class="container">
                <h1>GameZube</h1>
                <p>Watch your friends play games and stream your play-throughs! Stream your play through next to your friends, post to social media sites, challenge your friends and leave comments on their play-throughs!</p>
            </div>
        </div>

        <div class="jumbotron login">
            <div class="container">

                <!-- ROW -->
                <div class="col-md-12">
                    <a name="login"></a><h2>Login with...</h2> 
                    <span name="loginlogo" id="loginlogo"><em>Login with Mobile Connect</em></span>
                    <p>GameZube requires you to login using Mobile Connect, Mobile Connect uses your mobile phone number and network operator to log you in safely and securly. 
                    <div name="loginBlock" id="loginBlock" >
                        <div id="cannotFindOperator" style="display:block">
                            <p>We cannot detect your operator, please click below to locate discover your operator!</p>
                        </div>
                        <div id="foundOperator" style="display:none">
                            <p>Your operator has been identified as <span id="foundOperatorName"></span>, now you can login!</p>
                        </div>
                        <form>
                            <fieldset>
                                <input type="button" class="btn btn-primary" onClick="startDemo(); return false;" value="Login"/>
                            </fieldset>
                        </form>
                    </div>
                </div>

            </div><!-- /.container -->
        </div><!-- /.jumbotron -->

        <div class="jumbotron features">
            <div class="container">
                <a name="features"></a><h2>Features</h2>
                <p>With GameZube you can view all the stats from your friend's game play throughs, or walk on water, or turn back time, or find a way.</p>
            </div>
        </div>

        <div class="jumbotron contact">
            <div class="container">
                <a name="contact"></a><h2>Contact GameZube Support</h2>
                <p>Need to find us? How about sending us a tweet, visit us at our offices, send a carrier pigeon or contact one of our friendly support staff!</p>
                <div class="col-md-4" id="support">
                    <h3>Support</h3>
                    <canvas id="aCanvas">
                    Your browser does not support the HTML5 canvas tag.</canvas>
                    <p>If you have any problem please contact our helpful staff!</p>
                </div>
                <div class="col-md-4" id="officelocation">
                    <h3>Location</h3>
                    <canvas id="aCanvas">
                    Your browser does not support the HTML5 canvas tag.</canvas>
                    <p>Visit our new offices in the great city of Tokyo.</p>
                </div>
                <div class="col-md-4" id="social">
                    <h3>Social</h3>
                    <canvas id="aCanvas">
                    Your browser does not support the HTML5 canvas tag.</canvas>
                    <p>Contact us on Twitter!</p>
                </div>
            </div>
        </div>

        <footer class="footer">
          <div class="container">
            <p class="text-muted">© GameZube 2015</p>
          </div>
        </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap-sass-official/assets/javascripts/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
    <script src="assets/javascripts/app.js" rel="stylesheet"></script>
  </body>
</html>
