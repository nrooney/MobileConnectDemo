
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>GameZube</title>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/style.css" rel="stylesheet"> 

    <!-- Custom styles for this template -->
    <!-- <link href="bower_components/stylesheets/starter-template.css" rel="stylesheet"> -->

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="../../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<!-- MOBILE CONNECT DEMO -->
<!-- STEP 1: Downloading and including the HTML5 SDK. -->
<script language="JavaScript" src="../app/assets/javascripts/DiscoverySDK.js" type="text/javascript"></script>
<script language="JavaScript" src="../app/assets/javascripts/LogoSDK.js" type="text/javascript"></script>
<script language="JavaScript" src="../app/assets/javascripts/Base64Utils.js" type="text/javascript"></script>
<script language="JavaScript" src="../app/assets/javascripts/OpenIdConnectSDK.js" type="text/javascript"></script>

<script language="JavaScript">

window.localStorage.clear();

/*
{
"client_id": "828XdMklDx605VtbCm7B9XrR",
"client_secret": "yvTIka091UnCl449z74926wZ",
"status": "approved",
"type": "development",
"redirectUri": "https://api.exchange.gsma.com"
}


{
    "client_id": "Ik07mMFeBjx43Qc6W261hOQ1",
    "client_secret": "Z9hy5sz8DALmBpn6MR7Nvd04",
    "status": "approved",
    "type": "production",
    "redirectUri": "https://api.exchange.gsma.com"
}

Muthu said this works: 
{
    "client_id": "bAGDtUyghGlOMoml7mTD2SCypkjvXFfc",
    "client_secret": "eLnuTIpTZebOM1oB",
    "type": "development"
}

{
   "client_id": "zZcA87C8WpT1G8Sii4AiVi82wAg8AGvU",
   "client_secret": "G882M8yza3JrJYd6",
   "type": "production"
}

from afsar:
Client_ID            gn_4etsUykydKQ7KmluCfuOHZFka
Client_secret        XMulJazG3Y3nKjoWrcgKKYsYDHga
*/

var discoveryServiceUriDefault="https://stage-exchange-test.apigee.net/gsma/v2/discovery"; //NOT GOING TO CHANGE 
// var discoveryClientIDDefault="bAGDtUyghGlOMoml7mTD2SCypkjvXFfc"; //checked
// var discoveryClientSecretDefault="Z9hy5sz8DALmBpn6MR7Nvd04"; //checked
// var logoServiceUriDefault="https://sb1.exchange.gsma.com/v1/logo"; //checked

var discoveryServiceUri="https://stage-exchange-test.apigee.net/gsma/v2/discovery"; //checked
var discoveryClientID="bAGDtUyghGlOMoml7mTD2SCypkjvXFfc"; //checked
var discoveryClientSecret="Z9hy5sz8DALmBpn6MR7Nvd04"; //checked
var logoServiceUri="https://sb1.exchange.gsma.com/v1/logo"; //checked

var apiClientID=null;
var apiClientSecret=null;

var operatorIdentified=false;
var operatorName=null;
var mcc=null;
var mnc=null;
var subscriberId=null;

var authorizationEndpoint=null;

function atStartup() {
    getLogos();
}

function getLogos() {
    var sourceIP=null;
    var logosize="medium";
    var colormode="normal";
    var aspect="landscape";
    var mcc=null;
    var mnc=null;
    getLogo(logoServiceUri, mcc, mnc, sourceIP, 'operatorid', logosize, colormode, aspect, logoComplete);
}
  
function logoComplete(logoResult) {
    console.log("SUCCESS: Logo Load Complete");

    if (logoResult && logoResult.logos && logoResult.logos.length>=1) {
        var url = getCacheApiLogo('exchange', 'operatorid', 'medium', 'normal', 'landscape');
        if (!!url) {
            var first = logoResult.logos[0];
            url = first.url;
        }
        if (!!url) {
            $('#loginlogo').html('<img src=\''+url+'\'alt=\'Login with Mobile Connect\'/>');
        }
    }
}

function startDemo(){
    // steve's demo parsed mnc mcc here
    startActiveDiscovery();
}

function startActiveDiscovery() {
    var encrypt="basic";
    var sourceIP=null;
    var msisdn=null;
    var redirectUri="http://localhost/app/discovered.html"; //"https://api.exchange.gsma.com"
    var mcc=null;
    var mnc=null;

    getDiscoveryActive(discoveryServiceUri, discoveryClientID, discoveryClientSecret, encrypt, mcc, mnc, msisdn, sourceIP, redirectUri, activeDiscoveryComplete);
}

function activeDiscoveryComplete(discoveryResult, status) {
    console.log("SUCCESS: Active Discovery Complete");

    console.log("    HTTP Status Code: "+status);
    console.log("    Callback for: "+JSON.stringify(discoveryResult));
    // console.log("Location = "+window.location.href);

    if (status==200) {
        $('#status').val('Discovery complete');
        if (discoveryResult && !!discoveryResult.getResponse()) {
            if (discoveryResult.getResponse().
                getApiFunction('operatorid', 'authorization')) {
                runAuthorization(discoveryResult);
            }
        }
    }
}

function runAuthorization(discoveryResult) {
    console.log("IN FUNCTION: runAuthorization");

    var apiClientID=discoveryResult.getResponse().getClient_id();
    var subscriberId=discoveryResult.getResponse().getSubscriber_id();
    var authorizationEndpoint=discoveryResult.getResponse().getApiFunction('operatorid', 'authorization');

    var prompt='login';
    var max_age=3600;
    var acr_values='2';
    var login_hint=null;
    if (!!discoveryResult.subscriberId) {
        login_hint="ENCR_MSISDN:"+subscriberId;
    }

    var authorizationOptions = new AuthorizationOptions('page', 'en', 'en', 'Enter MSISDN', login_hint, null);
    var state='State'+Math.random().toString(36);
    var nonce='Nonce'+Math.random().toString(36);
    var redirect_uri='http://thisnatasha.com/mobileconnectdemo/app/authorization.html';

    // REWRITING THE AUTHORISATION ENDPOINT HERE TO REFLECT DIALOG PLATFORM
    authorizationEndpoint = "https://identity.mifetest.com:9443/oauth2/authorize";
    apiClientID = "gn_4etsUykydKQ7KmluCfuOHZFka";
    apiClientSecret = "XMulJazG3Y3nKjoWrcgKKYsYDHga";
    // END

    console.log("BEFORE AUTHORISE");
    console.log("    OVERWRITTEN authorizationEndpoint: " + authorizationEndpoint); 
    console.log("    OVERWRITTEN apiClientID: " + apiClientID);
    console.log("    redirect_uri: " + redirect_uri);
    console.log("    state: " + state);
    console.log("    nonce: " + nonce);
    console.log("    prompt: " + prompt);
    console.log("    max_age: " + max_age);
    console.log("    acr_values: " + acr_values);
    console.log("    authorizationOptions: ");
    console.log(authorizationOptions);
    authorize(authorizationEndpoint, apiClientID, 'openid profile email userinfo', redirect_uri, 'code', state, nonce, prompt, max_age, acr_values, authorizationOptions, authorizationCallbackFunction);
}

function authorizationCallbackFunction(data) {
    console.log("IN FUNCTION: authorizationCallbackFunction");
    console.log(data);

    var code=data['code'];
    var state=data['state'];
    var error=data['error'];

    var discoveryDetails=getCacheDiscoveryItem();
    var tokenEndpoint=discoveryDetails.getResponse().getApiFunction('operatorid', 'token');
    var apiClientID=discoveryDetails.getResponse().getClient_id();
    var apiClientSecret=discoveryDetails.getResponse().getClient_secret();

    // REWRITING THE TOKEN ENDPOINT HERE TO REFLECT DIALOG PLATFORM, CLIENT ID, CLIENT SECRET
    tokenEndpoint = "https://identity.mifetest.com:9443/oauth2/token";
    // END

    console.log("OVERWRITTEN tokenEndpoint: " + tokenEndpoint);
    console.log("OVERWRITTEN apiClientID: " + apiClientID);
    console.log("OVERWRITTEN apiClientSecret: " + apiClientSecret);

    // console.log("BEFORE call: tokenFromAuthorizationCode");      
    // if (code && code!=null && (code.trim().length)>0) {
        $('#status').val('Authorized');
        $('#code').val(code);

        tokenFromAuthorizationCode(tokenEndpoint, code, apiClientID, apiClientSecret,'http://mc.mobilesites.net/authorised.html', tokenReceived);
    // } else {
    //     console.log("error");
    //     $('#status').val('Error');
    // }
}

function tokenReceived(token) {
    console.log("IN FUNCTION: tokenReceived");
    console.log(token);

    if (!!token.refresh_token) $('#refresh_token').val(token.refresh_token);
    if (!!token.expires_in) $('#expires_in').val(token.expires_in);
    if (!!token.token_type) $('#token_type').val(token.token_type);
    if (!!token.access_token) {
        $('#access_token').val(token.access_token);
        var discoveryDetails = getCacheDiscoveryItem();
        var userinfoEndpoint = discoveryDetails.getResponse().getApiFunction('operatorid', 'userinfo');
        $('#status').val('Authorized + access token retrieved');
        if (userinfoEndpoint && userinfoEndpoint.trim().length>0) {
            userinfo(userinfoEndpoint, token.access_token, userinfoCallbackFunction);
        }
    }
}

function userinfoCallbackFunction(userinfo) {
    if (!!userinfo.email) $('#email').val(userinfo.email);
    if (userinfo && userinfo.email_verified!==null) 
        $('#email_verified').val(
            userinfo.email_verified?'true':'false');
}


</script>
<!-- /END MOBILE CONNECT DEMO -->

  </head>

  <body onLoad='javascript:atStartup();'>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">GameZube</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">Login</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
        
        <div class="jumbotron apptitle">
            <div class="container">
                <h1>GameZube</h1>
                <p>Watch your friends play games and stream your play-throughs! Stream your play through next to your friends, post to social media sites, challenge your friends and leave comments on their play-throughs!</p>
            </div>
        </div>

        <div class="jumbotron login">
            <div class="container">
                  <!-- <p>Login with your mobile carrier. </p>
                  <!-- <label>Preselected operator (passive discovery)</label> -->
                  <!-- <select name="preselectedOperator" id="preselectedOperator">
                      <option value="_" selected="selected">None</option>
                      <!-- <option value="002_04">Test operator</option>
                      <option value="413_02">Dialog Sri Lanka</option>
                      <option value="413_01">Mobitel Sri Lanka</option> -->
                  <!-- </select>

                  <!-- DISCOVERY BUTTON! -->
                  <!-- <p name="startPassiveBlock" id="startPassiveBlock"><input type="button" onClick="startDemo(); return false;" value="Start Discovery"/></p> -->
                  <!-- <input type="button" class="btn btn-default" onClick="startDemo(); return false;" value="Start Discovery"/>

                  <!-- <label>Discovery status:</label><input type="text" readonly="readonly" id="discoveryStatus" name="discoveryStatus" value="Not discovered"/>
                  <label>Operator:</label><input type="text" readonly="readonly" id="operatorName" name="operatorName" value="Not known"/> -->

                  <div class="row">
                    <div class="col-md-6 loginleft">
                        <h2>Login</h2> 
                        <p>GameZube requires you to login using Mobile Connect, Mobile Connect uses your mobile phone number and network operator to log you in safely and securly. 

                        <form>
                            <fieldset>
                                <div class="form-group">
                                  <label for="operatorSelect">Choose your Operator:</label>
                                  <select name="preselectedOperator" id="preselectedOperator" id="operatorSelect" class="form-control">
                                    <option value="_" selected="selected">None</option>
                                  </select>
                                </div>
                                <input type="button" class="btn btn-primary" onClick="startDemo(); return false;" value="Start Discovery"/>
                                
                                <fieldset disabled>
                                    <button type="submit" class="btn btn-primary">Login</button>
                                </fieldset>
                            </fieldset>
                        </form>

                    </div>
                    <div class="col-md-6 loginright">
                        <!-- LOGO -->
                        <div name="loginBlock" id="loginBlock" >
                            <span name="loginlogo" id="loginlogo"><em>Login with Mobile Connect</em></span>
                        </div>
                        
                    </div>
                </div>
            </div><!-- /.container -->
        </div><!-- /.jumbotron -->

        <div class="jumbotron features">
            <div class="container">
                <h2>Features</h2>
                <p>With GameZube you can view all the stats from your friend's game play throughs, or walk on water, or turn back time, or find a way.</p>
            </div>
        </div>

        <div class="jumbotron contact">
            <div class="container">
                <h2>Contact GameZube Support</h2>
                <p>Need to find us? How about sending us a tweet, visit us at our offices, send a carrier pigeon or contact one of our friendly support staff!</p>
            </div>
        </div>

        <footer class="footer">
          <div class="container">
            <p class="text-muted">Footer stuff.</p>
          </div>
        </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap-sass-official/assets/javascripts/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
    <script src="assets/javascripts/app.js" rel="stylesheet"></script>
  </body>
</html>
